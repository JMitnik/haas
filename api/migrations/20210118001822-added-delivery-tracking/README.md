# Migration `20210118001822-added-delivery-tracking`

This migration has been generated by Jonathan at 1/18/2021, 1:18:22 AM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE "public"."DeliveryEvents" ALTER COLUMN "deliveryId" DROP NOT NULL

ALTER TABLE "public"."Session" ADD COLUMN "deliveryId" text   ,
ADD COLUMN "originUrl" text   ,
ADD COLUMN "totalTimeInSec" integer   

ALTER TABLE "public"."Session" ADD FOREIGN KEY ("deliveryId")REFERENCES "public"."Delivery"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20210103223316-campaign-event-improvements..20210118001822-added-delivery-tracking
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource postgresql {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 // binaryTargets = ["debian-openssl-1.1.x"]
 generator client {
@@ -49,19 +49,20 @@
   customer         Customer?       @relation(fields: [customerId], references: [id])
 }
 model Customer {
-  id          String            @id @default(cuid())
-  slug        String            @unique
-  name        String
-  settings    CustomerSettings?
-  dialogues   Dialogue[]
-  users       UserOfCustomer[]
-  roles       Role[]
-  permissions Permission[]
-  triggers    Trigger[]
-  tags        Tag[]
-  campaigns   Campaign[]
+  id              String            @id @default(cuid())
+  slug            String            @unique
+  name            String
+  settings        CustomerSettings?
+  dialogues       Dialogue[]
+  users           UserOfCustomer[]
+  roles           Role[]
+  permissions     Permission[]
+  triggers        Trigger[]
+  tags            Tag[]
+  campaigns       Campaign[]
+  CampaignVariant CampaignVariant[]
 }
 enum TagEnum {
   DEFAULT
@@ -94,9 +95,10 @@
   tags             Tag[]
   isOnline         Boolean        @default(value: false)
   isWithoutGenData Boolean        @default(value: false)
-  wasGeneratedWithGenData Boolean @default(value: false)
+  wasGeneratedWithGenData Boolean           @default(value: false)
+  CampaignVariant         CampaignVariant[]
   @@unique([slug, customerId])
 }
 enum NodeType {
@@ -120,23 +122,27 @@
   number
 }
 model FormNodeField {
-  id    String        @id @default(cuid())
-  label String
-  type  FormNodeFieldType @default(shortText)
-  isRequired  Boolean @default(false)
-  position  Int
+  id                     String                   @id @default(cuid())
+  label                  String
+  type                   FormNodeFieldType        @default(shortText)
+  isRequired             Boolean                  @default(false)
+  position               Int
+  FormNode               FormNode?                @relation(fields: [formNodeId], references: [id])
+  formNodeId             String?
+  FormNodeFieldEntryData FormNodeFieldEntryData[]
 }
 model FormNode {
-  id           String           @id @default(cuid())
-  createdAt     DateTime        @default(now())
-  fields        FormNodeField[]
+  id           String          @id @default(cuid())
+  createdAt    DateTime        @default(now())
+  fields       FormNodeField[]
+  QuestionNode QuestionNode[]
 }
 model FormNodeFieldEntryData {
-  id          Int       @id @default(autoincrement())
+  id Int @id @default(autoincrement())
   // Data property (belonging to a specific field)
   email       String?
   phoneNumber String?
@@ -145,38 +151,43 @@
   longText    String?
   number      Int?
   relatedFieldId  String
-  relatedField  FormNodeField @relation(references: [id], fields: [relatedFieldId])
+  relatedField    FormNodeField  @relation(references: [id], fields: [relatedFieldId])
+  FormNodeEntry   FormNodeEntry? @relation(fields: [formNodeEntryId], references: [id])
+  formNodeEntryId Int?
 }
 model FormNodeEntry {
-  id          Int       @id @default(autoincrement())
-  values      FormNodeFieldEntryData[]
+  id     Int                      @id @default(autoincrement())
+  values FormNodeFieldEntryData[]
   // Relation to node
   nodeEntryId String
   nodeEntry   NodeEntry @relation(references: [id], fields: [nodeEntryId])
 }
 model SliderNodeRange {
-  id        String          @id @default(cuid())
-  start     Float?
-  end       Float?
+  id               String             @id @default(cuid())
+  start            Float?
+  end              Float?
+  SliderNodeMarker SliderNodeMarker[]
 }
 model SliderNodeMarker {
-  id        String          @id @default(cuid())
-  range     SliderNodeRange
-  label     String
-  subLabel  String
-  sliderNodeId  String
-  sliderNode    SliderNode  @relation(fields: [sliderNodeId], references: [id])
+  id                String          @id @default(cuid())
+  range             SliderNodeRange @relation(fields: [sliderNodeRangeId], references: [id])
+  label             String
+  subLabel          String
+  sliderNodeId      String
+  sliderNode        SliderNode      @relation(fields: [sliderNodeId], references: [id])
+  sliderNodeRangeId String
 }
 model SliderNode {
-  id        String          @id @default(cuid())
-  markers SliderNodeMarker[]
+  id           String             @id @default(cuid())
+  markers      SliderNodeMarker[]
+  QuestionNode QuestionNode[]
 }
 model QuestionNode {
   id           String           @id @default(cuid())
@@ -207,13 +218,15 @@
   triggers       Trigger[]
   // Node-types
   share      Share?
-  sliderNode SliderNode?
-  form  FormNode?
+  sliderNode SliderNode? @relation(fields: [sliderNodeId], references: [id])
+  form       FormNode?   @relation(fields: [formNodeId], references: [id])
   links             Link[]
   QuestionOfTrigger QuestionOfTrigger[]
+  sliderNodeId      String?
+  formNodeId        String?
 }
 enum LinkTypeEnum {
   SOCIAL
@@ -293,8 +306,14 @@
   id          String      @id @default(cuid())
   dialogueId  String
   dialogue    Dialogue    @relation(fields: [dialogueId], references: [id])
   nodeEntries NodeEntry[]
+
+  deliveryId String?
+  delivery   Delivery? @relation(fields: [deliveryId], references: [id])
+
+  originUrl      String?
+  totalTimeInSec Int?
 }
 // Node-entry types
 enum InputSource {
@@ -314,17 +333,17 @@
   relatedEdge   Edge?         @relation(fields: [relatedEdgeId], references: [id])
   inputSource   InputSource   @default(value: CLIENT)
   // Entry types
-  sliderNodeEntry       SliderNodeEntry?
-  choiceNodeEntry       ChoiceNodeEntry?
-  textboxNodeEntry      TextboxNodeEntry?
-  
+  sliderNodeEntry  SliderNodeEntry?
+  choiceNodeEntry  ChoiceNodeEntry?
+  textboxNodeEntry TextboxNodeEntry?
+
   // @Deprecated => FormNodeEntry
   registrationNodeEntry RegistrationNodeEntry?
-  
-  formNodeEntry         FormNodeEntry?
-  linkNodeEntry         LinkNodeEntry?
+
+  formNodeEntry FormNodeEntry?
+  linkNodeEntry LinkNodeEntry?
 }
 model LinkNodeEntry {
   id          Int       @id @default(autoincrement())
@@ -515,43 +534,47 @@
   QUEUE
 }
 model Campaign {
-  id  String  @id @default(cuid())
-  label       String
-  deliveries  Delivery[]
-  variantsEdges    CampaignVariantToCampaign[]
-  
-  workspaceId String   
+  id            String                      @id @default(cuid())
+  label         String
+  deliveries    Delivery[]
+  variantsEdges CampaignVariantToCampaign[]
+
+  workspaceId String
   workspace   Customer @relation(fields: [workspaceId], references: [id])
   createdAt DateTime @default(now())
   updatedAt DateTime @updatedAt
 }
 model CampaignVariantToCampaign {
-  campaignId  String
-  campaign  Campaign @relation(fields: [campaignId], references: [id])
+  campaignId String
+  campaign   Campaign @relation(fields: [campaignId], references: [id])
   campaignVariantId String
-  campaignVariant CampaignVariant @relation(fields: [campaignVariantId], references: [id])
+  campaignVariant   CampaignVariant @relation(fields: [campaignVariantId], references: [id])
-  // Weight decides in A/B testing which 
-  weight  Int
+  // Weight decides in A/B testing which
+  weight Int
   @@id([campaignId, campaignVariantId])
 }
 model CampaignVariant {
-  id  String @id @default(cuid())
-  label     String
-  body      String
-   
-  workspace   Customer
-  dialogue    Dialogue
+  id    String @id @default(cuid())
+  label String
+  body  String
-  subject   String?
-  type      CampaignVariantTypeEnum
+  workspace Customer @relation(fields: [customerId], references: [id])
+  dialogue  Dialogue @relation(fields: [dialogueId], references: [id])
+
+  subject                   String?
+  type                      CampaignVariantTypeEnum
+  CampaignVariantToCampaign CampaignVariantToCampaign[]
+  Delivery                  Delivery[]
+  customerId                String
+  dialogueId                String
 }
 enum DeliveryStatusTypeEnum {
   SCHEDULED
@@ -562,32 +585,34 @@
 }
 model Delivery {
   // We generated the ID ourselves
-  id  String @id
+  id String @id
   deliveryRecipientFirstName String?
-  deliveryRecipientLastName String?
-  deliveryRecipientEmail String?
-  deliveryRecipientPhone String?
+  deliveryRecipientLastName  String?
+  deliveryRecipientEmail     String?
+  deliveryRecipientPhone     String?
-  campaignId  String
-  campaign  Campaign @relation(fields: [campaignId], references: [id])
+  campaignId String
+  campaign   Campaign @relation(fields: [campaignId], references: [id])
   campaignVariantId String
-  campaignVariant CampaignVariant @relation(fields: [campaignVariantId], references: [id])
+  campaignVariant   CampaignVariant @relation(fields: [campaignVariantId], references: [id])
-  currentStatus  DeliveryStatusTypeEnum
+  currentStatus DeliveryStatusTypeEnum
-  events  DeliveryEvents[]
+  events DeliveryEvents[]
   scheduledAt DateTime
-  createdAt   DateTime @default(now())
+  createdAt   DateTime  @default(now())
   updatedAt   DateTime? @updatedAt
+  Session     Session[]
 }
 model DeliveryEvents {
-  id String @id @default(cuid())
-  status DeliveryStatusTypeEnum
-  createdAt DateTime @default(now())
-  deliveryId  String
-}
+  id         String                 @id @default(cuid())
+  status     DeliveryStatusTypeEnum
+  createdAt  DateTime               @default(now())
+  deliveryId String?
+  Delivery   Delivery?              @relation(fields: [deliveryId], references: [id])
+}
```


