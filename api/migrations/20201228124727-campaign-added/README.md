# Migration `20201228124727-campaign-added`

This migration has been generated by Jonathan at 12/28/2020, 1:47:27 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "public"."CampaignVariantTypeEnum" AS ENUM ('EMAIL', 'SMS', 'QUEUE')

CREATE TYPE "public"."DeliveryStatusTypeEnum" AS ENUM ('SCHEDULED', 'DEPLOYED', 'SENT', 'OPENED', 'FINISHED')

CREATE TABLE "public"."Campaign" (
"id" text   NOT NULL ,
"label" text   NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"updatedAt" timestamp(3)   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."CampaignVariantToCampaign" (
"campaignId" text   NOT NULL ,
"campaignVariantId" text   NOT NULL ,
"weight" Decimal(65,30)   NOT NULL ,
PRIMARY KEY ("campaignId","campaignVariantId")
)

CREATE TABLE "public"."CampaignVariant" (
"id" text   NOT NULL ,
"label" text   NOT NULL ,
"body" text   NOT NULL ,
"subject" text   ,
"type" "CampaignVariantTypeEnum"  NOT NULL ,
"customerId" text   NOT NULL ,
"dialogueId" text   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."Delivery" (
"id" text   NOT NULL ,
"campaignId" text   NOT NULL ,
"campaignVariantId" text   NOT NULL ,
"currentStatus" "DeliveryStatusTypeEnum"  NOT NULL ,
"scheduledAt" timestamp(3)   NOT NULL ,
PRIMARY KEY ("id")
)

CREATE TABLE "public"."DeliveryEvents" (
"id" text   NOT NULL ,
"status" "DeliveryStatusTypeEnum"  NOT NULL ,
"createdAt" timestamp(3)   NOT NULL DEFAULT CURRENT_TIMESTAMP,
"deliveryId" text   ,
PRIMARY KEY ("id")
)

ALTER TABLE "public"."CampaignVariantToCampaign" ADD FOREIGN KEY ("campaignId")REFERENCES "public"."Campaign"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CampaignVariantToCampaign" ADD FOREIGN KEY ("campaignVariantId")REFERENCES "public"."CampaignVariant"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CampaignVariant" ADD FOREIGN KEY ("customerId")REFERENCES "public"."Customer"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."CampaignVariant" ADD FOREIGN KEY ("dialogueId")REFERENCES "public"."Dialogue"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Delivery" ADD FOREIGN KEY ("campaignId")REFERENCES "public"."Campaign"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."Delivery" ADD FOREIGN KEY ("campaignVariantId")REFERENCES "public"."CampaignVariant"("id") ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE "public"."DeliveryEvents" ADD FOREIGN KEY ("deliveryId")REFERENCES "public"."Delivery"("id") ON DELETE SET NULL ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20201208134932-change-number..20201228124727-campaign-added
--- datamodel.dml
+++ datamodel.dml
@@ -1,7 +1,7 @@
 datasource postgresql {
   provider = "postgresql"
-  url = "***"
+  url = "***"
 }
 // binaryTargets = ["debian-openssl-1.1.x"]
 generator client {
@@ -501,4 +501,77 @@
   createdAt DateTime @default(now())
   @@id([questionId, triggerId])
 }
+
+// Campaigns
+enum CampaignVariantTypeEnum {
+  EMAIL
+  SMS
+  QUEUE
+}
+
+model Campaign {
+  id  String  @id @default(cuid())
+  label       String
+  deliveries  Delivery[]
+  variantsEdges    CampaignVariantToCampaign[]
+
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+}
+
+model CampaignVariantToCampaign {
+  campaignId  String
+  campaign  Campaign @relation(fields: [campaignId], references: [id])
+
+  campaignVariantId String
+  campaignVariant CampaignVariant @relation(fields: [campaignVariantId], references: [id])
+
+  // Weight decides in A/B testing which 
+  weight  Float
+
+  @@id([campaignId, campaignVariantId])
+}
+
+model CampaignVariant {
+  id  String @id @default(cuid())
+  label     String
+  body      String
+   
+  workspace   Customer
+  dialogue    Dialogue
+
+  subject   String?
+  type      CampaignVariantTypeEnum
+}
+
+enum DeliveryStatusTypeEnum {
+  SCHEDULED
+  DEPLOYED
+  SENT
+  OPENED
+  FINISHED
+}
+
+model Delivery {
+  // We generated the ID ourselves
+  id  String @id
+
+  campaignId  String
+  campaign  Campaign @relation(fields: [campaignId], references: [id])
+
+  campaignVariantId String
+  campaignVariant CampaignVariant @relation(fields: [campaignVariantId], references: [id])
+
+  currentStatus  DeliveryStatusTypeEnum
+
+  scheduledAt DateTime
+
+  events  DeliveryEvents[]
+}
+
+model DeliveryEvents {
+  id String @id @default(cuid())
+  status DeliveryStatusTypeEnum
+  createdAt DateTime @default(now())
+}
```


