Resources:
  TwilioHandlerhandletwilioapi9C2304FA:
    Type: AWS::ApiGateway::RestApi
    Properties:
      Name: handle-twilio-api
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/Resource
  TwilioHandlerhandletwilioapiCloudWatchRoleDB88E3F7:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: apigateway.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AmazonAPIGatewayPushToCloudWatchLogs
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/CloudWatchRole/Resource
  TwilioHandlerhandletwilioapiAccount9EEDFE96:
    Type: AWS::ApiGateway::Account
    Properties:
      CloudWatchRoleArn:
        Fn::GetAtt:
          - TwilioHandlerhandletwilioapiCloudWatchRoleDB88E3F7
          - Arn
    DependsOn:
      - TwilioHandlerhandletwilioapi9C2304FA
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/Account
  TwilioHandlerhandletwilioapiDeployment633D4D273e44603c00196cb5d1461360a87eae9d:
    Type: AWS::ApiGateway::Deployment
    Properties:
      RestApiId:
        Ref: TwilioHandlerhandletwilioapi9C2304FA
      Description: Automatically created by the RestApi construct
    DependsOn:
      - TwilioHandlerhandletwilioapiGETE2773FEB
      - TwilioHandlerhandletwilioapiPOSTD443291A
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/Deployment/Resource
  TwilioHandlerhandletwilioapiDeploymentStageprodF32BDBB8:
    Type: AWS::ApiGateway::Stage
    Properties:
      RestApiId:
        Ref: TwilioHandlerhandletwilioapi9C2304FA
      DeploymentId:
        Ref: TwilioHandlerhandletwilioapiDeployment633D4D273e44603c00196cb5d1461360a87eae9d
      StageName: prod
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/DeploymentStage.prod/Resource
  TwilioHandlerhandletwilioapiGETApiPermissionHAASCampaignTwilioHandlerhandletwilioapiBFE22C99GET1EE0292D:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - TwilioHandlertwiliosenderC36E7CED
          - Arn
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Join:
          - ""
          - - "arn:"
            - Ref: AWS::Partition
            - ":execute-api:"
            - Ref: AWS::Region
            - ":"
            - Ref: AWS::AccountId
            - ":"
            - Ref: TwilioHandlerhandletwilioapi9C2304FA
            - /
            - Ref: TwilioHandlerhandletwilioapiDeploymentStageprodF32BDBB8
            - /GET/
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/Default/GET/ApiPermission.HAASCampaignTwilioHandlerhandletwilioapiBFE22C99.GET..
  TwilioHandlerhandletwilioapiGETApiPermissionTestHAASCampaignTwilioHandlerhandletwilioapiBFE22C99GETAA3417B9:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - TwilioHandlertwiliosenderC36E7CED
          - Arn
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Join:
          - ""
          - - "arn:"
            - Ref: AWS::Partition
            - ":execute-api:"
            - Ref: AWS::Region
            - ":"
            - Ref: AWS::AccountId
            - ":"
            - Ref: TwilioHandlerhandletwilioapi9C2304FA
            - /test-invoke-stage/GET/
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/Default/GET/ApiPermission.Test.HAASCampaignTwilioHandlerhandletwilioapiBFE22C99.GET..
  TwilioHandlerhandletwilioapiGETE2773FEB:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: GET
      ResourceId:
        Fn::GetAtt:
          - TwilioHandlerhandletwilioapi9C2304FA
          - RootResourceId
      RestApiId:
        Ref: TwilioHandlerhandletwilioapi9C2304FA
      AuthorizationType: NONE
      Integration:
        IntegrationHttpMethod: POST
        Type: AWS_PROXY
        Uri:
          Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - ":apigateway:"
              - Ref: AWS::Region
              - :lambda:path/2015-03-31/functions/
              - Fn::GetAtt:
                  - TwilioHandlertwiliosenderC36E7CED
                  - Arn
              - /invocations
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/Default/GET/Resource
  TwilioHandlerhandletwilioapiPOSTApiPermissionHAASCampaignTwilioHandlerhandletwilioapiBFE22C99POST85DCA9AF:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - TwilioHandlertwiliohandler8E42D80F
          - Arn
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Join:
          - ""
          - - "arn:"
            - Ref: AWS::Partition
            - ":execute-api:"
            - Ref: AWS::Region
            - ":"
            - Ref: AWS::AccountId
            - ":"
            - Ref: TwilioHandlerhandletwilioapi9C2304FA
            - /
            - Ref: TwilioHandlerhandletwilioapiDeploymentStageprodF32BDBB8
            - /POST/
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/Default/POST/ApiPermission.HAASCampaignTwilioHandlerhandletwilioapiBFE22C99.POST..
  TwilioHandlerhandletwilioapiPOSTApiPermissionTestHAASCampaignTwilioHandlerhandletwilioapiBFE22C99POST59126068:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - TwilioHandlertwiliohandler8E42D80F
          - Arn
      Principal: apigateway.amazonaws.com
      SourceArn:
        Fn::Join:
          - ""
          - - "arn:"
            - Ref: AWS::Partition
            - ":execute-api:"
            - Ref: AWS::Region
            - ":"
            - Ref: AWS::AccountId
            - ":"
            - Ref: TwilioHandlerhandletwilioapi9C2304FA
            - /test-invoke-stage/POST/
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/Default/POST/ApiPermission.Test.HAASCampaignTwilioHandlerhandletwilioapiBFE22C99.POST..
  TwilioHandlerhandletwilioapiPOSTD443291A:
    Type: AWS::ApiGateway::Method
    Properties:
      HttpMethod: POST
      ResourceId:
        Fn::GetAtt:
          - TwilioHandlerhandletwilioapi9C2304FA
          - RootResourceId
      RestApiId:
        Ref: TwilioHandlerhandletwilioapi9C2304FA
      AuthorizationType: NONE
      Integration:
        IntegrationHttpMethod: POST
        RequestTemplates:
          application/json: '{ "statusCode": 200 }'
        Type: AWS_PROXY
        Uri:
          Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - ":apigateway:"
              - Ref: AWS::Region
              - :lambda:path/2015-03-31/functions/
              - Fn::GetAtt:
                  - TwilioHandlertwiliohandler8E42D80F
                  - Arn
              - /invocations
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/handle-twilio-api/Default/POST/Resource
  TwilioHandlerAPIURLDD9A1064:
    Type: AWS::SSM::Parameter
    Properties:
      Type: String
      Value:
        Fn::Join:
          - ""
          - - https://
            - Ref: TwilioHandlerhandletwilioapi9C2304FA
            - .execute-api.
            - Ref: AWS::Region
            - "."
            - Ref: AWS::URLSuffix
            - /
            - Ref: TwilioHandlerhandletwilioapiDeploymentStageprodF32BDBB8
            - /
      Name: TWILIO_CALLBACK_URL
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/API_URL/Resource
  TwilioHandlertwiliohandlerServiceRole279C28FF:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/twilio-handler/ServiceRole/Resource
  TwilioHandlertwiliohandlerServiceRoleDefaultPolicyE1BEE6F1:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: dynamodb:UpdateItem
            Effect: Allow
            Resource: arn:aws:dynamodb:eu-central-1:649621042808:table/CampaignDeliveries
        Version: "2012-10-17"
      PolicyName: TwilioHandlertwiliohandlerServiceRoleDefaultPolicyE1BEE6F1
      Roles:
        - Ref: TwilioHandlertwiliohandlerServiceRole279C28FF
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/twilio-handler/ServiceRole/DefaultPolicy/Resource
  TwilioHandlertwiliohandler8E42D80F:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: AssetParameters0d0c170bdc70f6e8f303258d0ecb18c90416661329ac2e6c86ba70f9253750a8S3BucketDA933FC7
        S3Key:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: AssetParameters0d0c170bdc70f6e8f303258d0ecb18c90416661329ac2e6c86ba70f9253750a8S3VersionKey1D2E3C4D
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: AssetParameters0d0c170bdc70f6e8f303258d0ecb18c90416661329ac2e6c86ba70f9253750a8S3VersionKey1D2E3C4D
      Role:
        Fn::GetAtt:
          - TwilioHandlertwiliohandlerServiceRole279C28FF
          - Arn
      Environment:
        Variables:
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: "1"
      Handler: twilio-handler.main
      Runtime: nodejs12.x
    DependsOn:
      - TwilioHandlertwiliohandlerServiceRoleDefaultPolicyE1BEE6F1
      - TwilioHandlertwiliohandlerServiceRole279C28FF
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/twilio-handler/Resource
      aws:asset:path: asset.0d0c170bdc70f6e8f303258d0ecb18c90416661329ac2e6c86ba70f9253750a8
      aws:asset:property: Code
  TwilioHandlertwiliosenderServiceRole8003B9B0:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/twilio-sender/ServiceRole/Resource
  TwilioHandlertwiliosenderServiceRoleDefaultPolicy67315BBA:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: ssm:GetParameter
            Effect: Allow
            Resource: arn:aws:ssm:eu-central-1:649621042808:parameter/TWILIO_CALLBACK_URL
        Version: "2012-10-17"
      PolicyName: TwilioHandlertwiliosenderServiceRoleDefaultPolicy67315BBA
      Roles:
        - Ref: TwilioHandlertwiliosenderServiceRole8003B9B0
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/twilio-sender/ServiceRole/DefaultPolicy/Resource
  TwilioHandlertwiliosenderC36E7CED:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: AssetParametersf04a2a03b9d3592af1a11ecc1b761a06ee7815c9ec24cda2b4907bd28d7903bcS3Bucket92BA8980
        S3Key:
          Fn::Join:
            - ""
            - - Fn::Select:
                  - 0
                  - Fn::Split:
                      - "||"
                      - Ref: AssetParametersf04a2a03b9d3592af1a11ecc1b761a06ee7815c9ec24cda2b4907bd28d7903bcS3VersionKeyEE352DC9
              - Fn::Select:
                  - 1
                  - Fn::Split:
                      - "||"
                      - Ref: AssetParametersf04a2a03b9d3592af1a11ecc1b761a06ee7815c9ec24cda2b4907bd28d7903bcS3VersionKeyEE352DC9
      Role:
        Fn::GetAtt:
          - TwilioHandlertwiliosenderServiceRole8003B9B0
          - Arn
      Environment:
        Variables:
          TWILIO_ACCOUNT_SID:
            Fn::Join:
              - ""
              - - "{{resolve:secretsmanager:arn:"
                - Ref: AWS::Partition
                - ":secretsmanager:"
                - Ref: AWS::Region
                - ":"
                - Ref: AWS::AccountId
                - :secret:TWILIO_PROD:SecretString:TWILIO_ACCOUNT_SID::}}
          TWILIO_AUTH_TOKEN:
            Fn::Join:
              - ""
              - - "{{resolve:secretsmanager:arn:"
                - Ref: AWS::Partition
                - ":secretsmanager:"
                - Ref: AWS::Region
                - ":"
                - Ref: AWS::AccountId
                - :secret:TWILIO_PROD:SecretString:TWILIO_AUTH_TOKEN::}}
          TWILIO_MESSAGE_SERVICE_SID:
            Fn::Join:
              - ""
              - - "{{resolve:secretsmanager:arn:"
                - Ref: AWS::Partition
                - ":secretsmanager:"
                - Ref: AWS::Region
                - ":"
                - Ref: AWS::AccountId
                - :secret:TWILIO_PROD:SecretString:TWILIO_MESSAGE_SERVICE_SID::}}
          AWS_NODEJS_CONNECTION_REUSE_ENABLED: "1"
      Handler: index.main
      Runtime: nodejs12.x
    DependsOn:
      - TwilioHandlertwiliosenderServiceRoleDefaultPolicy67315BBA
      - TwilioHandlertwiliosenderServiceRole8003B9B0
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/twilio-sender/Resource
      aws:asset:path: asset.f04a2a03b9d3592af1a11ecc1b761a06ee7815c9ec24cda2b4907bd28d7903bc
      aws:asset:property: Code
  TwilioHandlertwiliosenderAllowInvokeHAASCampaignTwilioHandlerTwilioSMSTopic256FB990636295FE:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - TwilioHandlertwiliosenderC36E7CED
          - Arn
      Principal: sns.amazonaws.com
      SourceArn:
        Ref: TwilioHandlerTwilioSMSTopicCAC070CF
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/twilio-sender/AllowInvoke:HAASCampaignTwilioHandlerTwilioSMSTopic256FB990
  TwilioHandlertwiliosenderTwilioSMSTopic416807D5:
    Type: AWS::SNS::Subscription
    Properties:
      Protocol: lambda
      TopicArn:
        Ref: TwilioHandlerTwilioSMSTopicCAC070CF
      Endpoint:
        Fn::GetAtt:
          - TwilioHandlertwiliosenderC36E7CED
          - Arn
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - TwilioHandlerTwilioSMSDLQE7AC764F
            - Arn
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/twilio-sender/Twilio_SMS_Topic/Resource
  TwilioHandlerTwilioSMSDLQE7AC764F:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 1209600
      QueueName: MySubscription_DLQ
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/Twilio_SMS_DLQ/Resource
  TwilioHandlerTwilioSMSDLQPolicyFF468EE2:
    Type: AWS::SQS::QueuePolicy
    Properties:
      PolicyDocument:
        Statement:
          - Action: sqs:SendMessage
            Condition:
              ArnEquals:
                aws:SourceArn:
                  Ref: TwilioHandlerTwilioSMSTopicCAC070CF
            Effect: Allow
            Principal:
              Service: sns.amazonaws.com
            Resource:
              Fn::GetAtt:
                - TwilioHandlerTwilioSMSDLQE7AC764F
                - Arn
        Version: "2012-10-17"
      Queues:
        - Ref: TwilioHandlerTwilioSMSDLQE7AC764F
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/Twilio_SMS_DLQ/Policy/Resource
  TwilioHandlerTwilioSMSTopicCAC070CF:
    Type: AWS::SNS::Topic
    Properties:
      DisplayName: Twilio SMS Topic
      TopicName: twilioSMSTopic
    Metadata:
      aws:cdk:path: HAASCampaign/TwilioHandler/Twilio_SMS_Topic/Resource
  CDKMetadata:
    Type: AWS::CDK::Metadata
    Properties:
      Analytics: v2:deflate64:H4sIAAAAAAAAE1VQ0VbCMAz9Ft67IvKCbyIe31REf6B0cWSs7WxSOTs7+3fbjiG8NPemyc1NFvJhJe9mj+pEhS6P8147D7L/ZKWPYuMssQ+axebbvgduA4sdkAteg1gTAce6Cm2V/rfKKwMMPpFLVcRRpURGZweRpvSqxUoxnFQn+1jH6xbPLRNca+2CZfEMbeM6AzYbuGJpbNYewTTtSRGIV+CDK9PniAaBysRJrskdOW5dg7rLrjMaRKPMvlSyTynwBomi4VTwEqwezROZdBgf973Z9UImlcK6EmqSbzlMAoKWhUo3I5lPJ8hS1At70h5bPo+74V+uRZ2yGUQHP7HjI0DIm4wgv//7XNFhGERyImua/y7u5WIll7OaEAsfj4sG5G6Mf4KIT+4EAgAA
    Metadata:
      aws:cdk:path: HAASCampaign/CDKMetadata/Default
    Condition: CDKMetadataAvailable
Outputs:
  TwilioHandlerhandletwilioapiEndpointCBD70E9C:
    Value:
      Fn::Join:
        - ""
        - - https://
          - Ref: TwilioHandlerhandletwilioapi9C2304FA
          - .execute-api.
          - Ref: AWS::Region
          - "."
          - Ref: AWS::URLSuffix
          - /
          - Ref: TwilioHandlerhandletwilioapiDeploymentStageprodF32BDBB8
          - /
Parameters:
  AssetParameters0d0c170bdc70f6e8f303258d0ecb18c90416661329ac2e6c86ba70f9253750a8S3BucketDA933FC7:
    Type: String
    Description: S3 bucket for asset "0d0c170bdc70f6e8f303258d0ecb18c90416661329ac2e6c86ba70f9253750a8"
  AssetParameters0d0c170bdc70f6e8f303258d0ecb18c90416661329ac2e6c86ba70f9253750a8S3VersionKey1D2E3C4D:
    Type: String
    Description: S3 key for asset version "0d0c170bdc70f6e8f303258d0ecb18c90416661329ac2e6c86ba70f9253750a8"
  AssetParameters0d0c170bdc70f6e8f303258d0ecb18c90416661329ac2e6c86ba70f9253750a8ArtifactHash3476D339:
    Type: String
    Description: Artifact hash for asset "0d0c170bdc70f6e8f303258d0ecb18c90416661329ac2e6c86ba70f9253750a8"
  AssetParametersf04a2a03b9d3592af1a11ecc1b761a06ee7815c9ec24cda2b4907bd28d7903bcS3Bucket92BA8980:
    Type: String
    Description: S3 bucket for asset "f04a2a03b9d3592af1a11ecc1b761a06ee7815c9ec24cda2b4907bd28d7903bc"
  AssetParametersf04a2a03b9d3592af1a11ecc1b761a06ee7815c9ec24cda2b4907bd28d7903bcS3VersionKeyEE352DC9:
    Type: String
    Description: S3 key for asset version "f04a2a03b9d3592af1a11ecc1b761a06ee7815c9ec24cda2b4907bd28d7903bc"
  AssetParametersf04a2a03b9d3592af1a11ecc1b761a06ee7815c9ec24cda2b4907bd28d7903bcArtifactHash1F8419E4:
    Type: String
    Description: Artifact hash for asset "f04a2a03b9d3592af1a11ecc1b761a06ee7815c9ec24cda2b4907bd28d7903bc"
Conditions:
  CDKMetadataAvailable:
    Fn::Or:
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - af-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-northeast-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-northeast-2
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-southeast-1
          - Fn::Equals:
              - Ref: AWS::Region
              - ap-southeast-2
          - Fn::Equals:
              - Ref: AWS::Region
              - ca-central-1
          - Fn::Equals:
              - Ref: AWS::Region
              - cn-north-1
          - Fn::Equals:
              - Ref: AWS::Region
              - cn-northwest-1
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-central-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-north-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-1
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-2
          - Fn::Equals:
              - Ref: AWS::Region
              - eu-west-3
          - Fn::Equals:
              - Ref: AWS::Region
              - me-south-1
          - Fn::Equals:
              - Ref: AWS::Region
              - sa-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-east-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-east-2
      - Fn::Or:
          - Fn::Equals:
              - Ref: AWS::Region
              - us-west-1
          - Fn::Equals:
              - Ref: AWS::Region
              - us-west-2

